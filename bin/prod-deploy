#!/usr/bin/env sh

# Get application credentials
bindir="$(realpath ${0%/*})"
creds=$("$bindir/prod-creds")

fetch_credential() {
  echo $creds | jp "$1" | tr -d '"'
}

container_registry_url=$(fetch_credential "azure.container_registry.url")
container_registry_username=$(fetch_credential "azure.container_registry.username")
container_registry_password=$(fetch_credential "azure.container_registry.password")

puts() {
  echo "==========="
  echo $1
  echo "==========="
}

# build client application
puts 'Building client application...'
cd client && npm run build && cd ..

# build docker container
puts 'Building docker container...'
docker build --tag workout-app . --no-cache || exit

# remove old docker image
puts 'Removing old docker image...'
docker rmi "$container_registry_url/workout-app:v1.0.0"

# login to docker
puts 'Logging in to docker container registry..'
docker login "$container_registry_url" --username "$container_registry_username" --password "$container_registry_password" || exit

# tag docker image
puts 'Tagging docker image'
docker tag workout-app "$container_registry_url/workout-app:v1.0.0" || exit

# push docker image
puts 'Pushing docker image'
docker push "$container_registry_url/workout-app:v1.0.0" || exit

# restart web app in azure
puts 'Restarting webapp in azure'
az webapp restart --name StrongerWebApp --resource-group StrongerApp
